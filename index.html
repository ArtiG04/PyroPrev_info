<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PyroPrev BLE Monitor</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2b7cff"/>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:8px;background:#fafafa;color:#111}
    header{display:flex;align-items:center;gap:12px}
    h3{margin:0 0 8px 0}
    .controls{margin:10px 0}
    button{margin-right:6px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff}
    button:disabled{opacity:0.5}
    canvas{max-width:100%;background:#fff;border:1px solid #e6e6e6;border-radius:6px;padding:6px}
    .status{margin-left:8px;font-weight:600}
    .card{margin-bottom:12px}
    footer{font-size:12px;margin-top:10px;color:#666}
  </style>
</head>
<body>
  <header>
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='40' height='40' rx='6' fill='%232b7cff'/><text x='50%' y='55%' font-size='20' fill='white' text-anchor='middle' font-family='Arial' font-weight='bold'>P</text></svg>" alt="logo" width="40" height="40">
    <div>
      <h3>PyroPrev BLE Monitor</h3>
      <div style="font-size:13px;color:#555">Conectar a tu ESP32 vía BLE (Chrome Android)</div>
    </div>
  </header>

  <div class="controls">
    <button id="btnConnect">Conectar BLE</button>
    <button id="btnSnap" disabled>Snap</button>
    <button id="btnCalibMQ" disabled>Calibrar MQ</button>
    <button id="btnCalibEnv" disabled>Calibrar Temp/Hum</button>
    <button id="btnCalibAll" disabled>Calibrar Todo</button>
    <span class="status" id="status">Desconectado</span>
  </div>

  <div class="card"><h4>MQ (RAW + AVG)</h4><canvas id="mqChart" height="180"></canvas></div>
  <div class="card"><h4>Temperatura (°C)</h4><canvas id="tChart" height="120"></canvas></div>
  <div class="card"><h4>Humedad (%)</h4><canvas id="hChart" height="120"></canvas></div>

  <footer>
    Página web de Arti Technologies. Copyright 2025.
  </footer>

<script>
/* CONFIG */
const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
const DATA_UUID    = '12345678-1234-5678-1234-56789abcdef1';
const CMD_UUID     = '12345678-1234-5678-1234-56789abcdef2';

let device = null;
let server = null;
let service = null;
let dataChar = null;
let cmdChar = null;

let mqChart, tChart, hChart;
const MAX_POINTS = 200;
let labels = [], mqRawArr = [], mqAvgArr = [], tempArr = [], humArr = [];
let baseline = 0, threshold = 0;

/* BUFFER para reensamblar notificaciones fragmentadas */
let pendingNotif = '';

/* Charts */
function makeCharts(){
  const ctxM = document.getElementById('mqChart').getContext('2d');
  mqChart = new Chart(ctxM, {
    type:'line',
    data:{
      labels: labels,
      datasets:[
        { label:'RAW_MQ',  data: mqRawArr, borderColor:'rgba(255,99,132,1)', fill:false, pointRadius:1 },
        { label:'AVG_MQ',  data: mqAvgArr, borderColor:'rgba(54,162,235,1)', fill:false, pointRadius:1 },
        { label:'BASELINE',data: [],       borderColor:'rgba(0,0,0,0.6)', borderDash:[6,4], fill:false, pointRadius:0 },
        { label:'THRESHOLD',data: [],      borderColor:'rgba(0,0,0,0.8)', borderDash:[2,2], fill:false, pointRadius:0 }
      ]
    },
    options:{ animation:false, scales:{ x:{ display:true }, y:{ display:true } }, plugins:{legend:{display:true}}}
  });

  const ctxT = document.getElementById('tChart').getContext('2d');
  tChart = new Chart(ctxT, {
    type:'line',
    data:{ labels: labels, datasets:[{ label:'Temp (°C)', data: tempArr, borderColor:'rgba(255,159,64,1)', fill:false, pointRadius:1 }]},
    options:{ animation:false }
  });

  const ctxH = document.getElementById('hChart').getContext('2d');
  hChart = new Chart(ctxH, {
    type:'line',
    data:{ labels: labels, datasets:[{ label:'Hum (%)', data: humArr, borderColor:'rgba(75,192,192,1)', fill:false, pointRadius:1 }]},
    options:{ animation:false }
  });
}

function pushPoint(ts, raw, avg, t, h) {
  const tstr = new Date(ts*1000).toLocaleTimeString();
  labels.push(tstr);
  mqRawArr.push(raw);
  mqAvgArr.push(avg);
  tempArr.push(t);
  humArr.push(h);
  if (labels.length > MAX_POINTS) {
    labels.shift(); mqRawArr.shift(); mqAvgArr.shift(); tempArr.shift(); humArr.shift();
  }
  const n = labels.length;
  mqChart.data.datasets[2].data = Array(n).fill(baseline);
  mqChart.data.datasets[3].data = Array(n).fill(threshold);

  mqChart.update();
  tChart.update();
  hChart.update();
}

/* UI helpers */
function setButtonsConnected(connected) {
  document.getElementById('btnSnap').disabled = !connected;
  document.getElementById('btnCalibMQ').disabled = !connected;
  document.getElementById('btnCalibEnv').disabled = !connected;
  document.getElementById('btnCalibAll').disabled = !connected;
  const btnConnect = document.getElementById('btnConnect');
  btnConnect.innerText = connected ? 'Desconectar' : 'Conectar BLE';
}

/* disconnect handler */
function onDisconnected(evt) {
  console.log('Device disconnected', evt);
  document.getElementById('status').innerText = 'Desconectado';
  setButtonsConnected(false);
  try { if (device && device.gatt && device.gatt.connected) device.gatt.disconnect(); } catch(e){}
  device = null; server = null; service = null; dataChar = null; cmdChar = null;
}

/* connect + start notifications */
async function connectBLE() {
  try {
    document.getElementById('status').innerText = 'Buscando PyroPrev (BLE)...';
    try {
      device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'PyroPrev' }],
        optionalServices: [SERVICE_UUID]
      });
    } catch (errFilter) {
      console.warn('Filtro no encontró dispositivo, reintentando acceptAllDevices', errFilter);
      device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [SERVICE_UUID]
      });
    }
    if (!device) { document.getElementById('status').innerText = 'No se seleccionó dispositivo'; return; }
    device.addEventListener('gattserverdisconnected', onDisconnected);
    document.getElementById('status').innerText = 'Conectando...';
    server = await device.gatt.connect();
    console.log('GATT connected:', server.connected, device.name, device.id);

    service = await server.getPrimaryService(SERVICE_UUID);
    dataChar = await service.getCharacteristic(DATA_UUID);
    cmdChar  = await service.getCharacteristic(CMD_UUID);

    await dataChar.startNotifications();
    dataChar.addEventListener('characteristicvaluechanged', handleDataNotification);
    console.log('startNotifications OK on dataChar');

    document.getElementById('status').innerText = 'Conectado: ' + (device.name || '(sin nombre)');
    setButtonsConnected(true);
  } catch (err) {
    console.error('connectBLE error', err);
    document.getElementById('status').innerText = 'Error conexión: ' + (err && err.message ? err.message : err);
    setButtonsConnected(false);
  }
}

/* handleDataNotification robusto: reensambla fragmentos usando '\n' como delimitador */
function handleDataNotification(event) {
  try {
    const value = event.target.value;
    if (!value) return;

    // tomar bytes exactos (respetando byteOffset/byteLength)
    const arr = new Uint8Array(value.buffer, value.byteOffset, value.byteLength);
    const fragment = new TextDecoder().decode(arr);
    // DEBUG opcional
    // console.log('Fragment received:', fragment);

    // append al buffer
    pendingNotif += fragment;

    // split por newline. Las líneas completas serán procesadas; la última parte puede quedar incompleta.
    const parts = pendingNotif.split('\n');

    // procesar todas las líneas completas (todas menos la última)
    for (let i = 0; i < parts.length - 1; i++) {
      const jsonStr = parts[i].trim();
      if (!jsonStr) continue;
      try {
        const data = JSON.parse(jsonStr);

        if (typeof data.baseline === 'number') baseline = data.baseline;
        if (typeof data.threshold === 'number') threshold = data.threshold;

        const ts = (typeof data.ts === 'number') ? data.ts : Math.floor(Date.now()/1000);
        const raw = (typeof data.mqRaw === 'number') ? data.mqRaw : 0;
        const avg = (typeof data.mqAvg === 'number') ? data.mqAvg : 0;
        const temp = (typeof data.temp === 'number') ? data.temp : 0;
        const hum  = (typeof data.hum === 'number') ? data.hum : 0;

        pushPoint(ts, raw, avg, temp, hum);
        document.getElementById('status').innerText = 'Última lectura: ' + new Date(ts*1000).toLocaleTimeString();
      } catch (e) {
        console.warn('JSON parse failed for line:', jsonStr, e);
      }
    }

    // dejar en pendingNotif la parte incompleta (último elemento)
    pendingNotif = parts[parts.length - 1];
  } catch (err) {
    console.warn('notification parse error', err);
  }
}

/* send command via characteristic write */
async function sendCmd(cmd) {
  if (!cmdChar) { console.warn('No cmd characteristic'); document.getElementById('status').innerText = 'Sin característica CMD'; return; }
  try {
    const enc = new TextEncoder();
    await cmdChar.writeValue(enc.encode(cmd));
    document.getElementById('status').innerText = 'Comando enviado: ' + cmd;
  } catch (err) {
    console.error('sendCmd error', err);
    document.getElementById('status').innerText = 'Error enviando cmd';
  }
}

/* wiring UI */
document.getElementById('btnConnect').addEventListener('click', async ()=> {
  try {
    if (device && device.gatt && device.gatt.connected) {
      device.gatt.disconnect();
      document.getElementById('status').innerText = 'Desconectando...';
      return;
    }
    if (!navigator.bluetooth) { alert('Web Bluetooth no soportado. Usa Chrome Android.'); return; }
    await connectBLE();
  } catch (e) { console.error('btnConnect error', e); }
});

document.getElementById('btnSnap').addEventListener('click', ()=> sendCmd('SNAP'));
document.getElementById('btnCalibMQ').addEventListener('click', ()=> { if (confirm('Calibrar MQ en AIRE LIMPIO?')) sendCmd('MQ'); });
document.getElementById('btnCalibEnv').addEventListener('click', ()=> { if (confirm('Calibrar Temp/Hum?')) sendCmd('ENV'); });
document.getElementById('btnCalibAll').addEventListener('click', ()=> { if (confirm('Calibrar TODO (MQ + Temp/Hum)?')) sendCmd('ALL'); });

/* init */
makeCharts();
setButtonsConnected(false);
window.addEventListener('beforeunload', () => { try { if (device && device.gatt && device.gatt.connected) device.gatt.disconnect(); } catch(e){} });

</script>
</body>
</html>
