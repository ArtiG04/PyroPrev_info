<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PyroPrev BLE Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2b7cff"/>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:8px;background:#fafafa;color:#111}
    header{display:flex;align-items:center;gap:12px}
    h3{margin:0 0 8px 0}
    .controls{margin:10px 0}
    button{margin-right:6px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff}
    button:disabled{opacity:0.5}
    canvas{max-width:100%;background:#fff;border:1px solid #e6e6e6;border-radius:6px;padding:6px}
    .status{margin-left:8px;font-weight:600}
    .card{margin-bottom:12px}
    footer{font-size:12px;margin-top:10px;color:#666}
    .debug-box{white-space:pre-wrap;font-family:monospace;background:#fff;border:1px solid #eee;padding:8px;height:120px;overflow:auto;border-radius:6px;margin-top:8px}
    .value-inline { font-weight:700; margin-left:8px; color:#333; font-size:0.95rem;}
    .indicator { font-weight:700; margin-left:12px; font-size:0.9rem; color:#666 }
    .indicator.yes { color: #c62828 }   /* rojo para YES */
    .indicator.no { color: #666 }      /* gris para NO */
  </style>
</head>
<body>
  <header>
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='40' height='40' rx='6' fill='%232b7cff'/><text x='50%' y='55%' font-size='20' fill='white' text-anchor='middle' font-family='Arial' font-weight='bold'>P</text></svg>" alt="logo" width="40" height="40">
    <div>
      <h3>PyroPrev BLE Monitor</h3>
      <div style="font-size:13px;color:#555">Conectar a tu ESP32 vía BLE (Chrome Android)</div>
    </div>
  </header>

  <div class="controls">
    <button id="btnConnect">Conectar BLE</button>
    <button id="btnSnap" disabled>Snap</button>
    <button id="btnCalibMQ" disabled>Calibrar MQ</button>
    <button id="btnCalibEnv" disabled>Calibrar Temp/Hum</button>
    <button id="btnCalibAll" disabled>Calibrar Todo</button>
    <button id="btnTestData">Test Data</button>
    <label style="margin-left:6px"><input type="checkbox" id="chkShowRaw"> Mostrar RAW</label>
    <span class="status" id="status">Desconectado</span>
  </div>

  <div class="card">
    <h4>
      MQ (RAW + AVG)
      <span class="value-inline" id="rawNowValue">RAW: —</span>
      <span id="rawIndicator" class="indicator no">SMOKE: NO</span>
    </h4>
    <canvas id="mqChart" height="180"></canvas>
  </div>

  <div class="card">
    <h4>
      Temperatura (°C)
      <span class="value-inline" id="tempNowValue">— °C</span>
      <span id="tempIndicator" class="indicator no">FIRE: NO</span>
    </h4>
    <canvas id="tChart" height="120"></canvas>
  </div>

  <div class="card">
    <h4>
      Humedad (%)
      <span class="value-inline" id="humNowValue">— %</span>
      <span id="humIndicator" class="indicator no">FIRE: NO</span>
    </h4>
    <canvas id="hChart" height="120"></canvas>
  </div>

  <div style="margin-top:8px">
    <strong>Debug (últimos fragments):</strong>
    <div class="debug-box" id="debugBox"></div>
  </div>

  <footer>
    Página web de Arti Technologies. Copyright 2025.
  </footer>

<script>
/* CONFIG */
const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
const DATA_UUID    = '12345678-1234-5678-1234-56789abcdef1';
const CMD_UUID     = '12345678-1234-5678-1234-56789abcdef2';

let device=null, server=null, service=null, dataChar=null, cmdChar=null;
let pendingNotif = '';

/* Charts */
const MAX_POINTS = 50; // <-- mostrar sólo últimas 50 muestras
let labels=[], mqRawArr=[], mqAvgArr=[], tempArr=[], humArr=[];
let baseline=0, threshold=0;
let mqChart, tChart, hChart;

function appendDebug(msg){
  const box = document.getElementById('debugBox');
  const time = new Date().toLocaleTimeString();
  box.textContent = `[${time}] ${msg}\n` + box.textContent;
  if (box.textContent.length > 20000) box.textContent = box.textContent.slice(0,20000);
}

function makeCharts(){
  const ctxM = document.getElementById('mqChart').getContext('2d');
  mqChart = new Chart(ctxM, {
    type:'line',
    data:{
      labels: labels,
      datasets:[
        { label:'RAW', data: mqRawArr, fill:false, pointRadius:1 },
        { label:'AVG', data: mqAvgArr, fill:false, pointRadius:1 },
        { label:'BL', data: [], borderDash:[6,4], fill:false, pointRadius:0 },
        { label:'THD', data: [], borderDash:[2,2], fill:false, pointRadius:0 }
      ]
    },
    options:{ animation:false, scales:{ x:{ display:true }, y:{ display:true } }, plugins:{legend:{display:true}}}
  });

  tChart = new Chart(document.getElementById('tChart').getContext('2d'), {
    type:'line',
    data:{ labels: labels, datasets:[{ label:'Temp (°C)', data: tempArr, fill:false, pointRadius:1 }]},
    options:{ animation:false, scales:{ x:{ display:true }, y:{ display:true } }, plugins:{legend:{display:true}}}
  });

  hChart = new Chart(document.getElementById('hChart').getContext('2d'), {
    type:'line',
    data:{ labels: labels, datasets:[{ label:'Hum (%)', data: humArr, fill:false, pointRadius:1 }]},
    options:{ animation:false, scales:{ x:{ display:true }, y:{ display:true } }, plugins:{legend:{display:true}}}
  });
}

function clampArrayToMax(arr){
  while (arr.length > MAX_POINTS) arr.shift();
}

/* pushPoint ahora recibe flags smoke y fire y actualiza colores/indicadores */
function pushPoint(ts, raw, avg, t, h, smoke=false, fire=false) {
  const rawNum = (raw === null || raw === undefined) ? null : Number(raw);
  const avgNum = (avg === null || avg === undefined) ? null : Number(avg);
  const tNum = (t === null || t === undefined) ? null : Number(t);
  const hNum = (h === null || h === undefined) ? null : Number(h);

  const tstr = new Date(ts*1000).toLocaleTimeString();
  labels.push(tstr);
  mqRawArr.push(rawNum);
  mqAvgArr.push(avgNum);
  tempArr.push(tNum);
  humArr.push(hNum);

  clampArrayToMax(labels);
  clampArrayToMax(mqRawArr);
  clampArrayToMax(mqAvgArr);
  clampArrayToMax(tempArr);
  clampArrayToMax(humArr);

  const n = labels.length;
  mqChart.data.datasets[2].data = Array(n).fill(baseline);
  mqChart.data.datasets[3].data = Array(n).fill(threshold);

  // actualizar valores actuales junto a los títulos y aplicar color/indicadores
  const rawNowEl = document.getElementById('rawNowValue');
  const tempNowEl = document.getElementById('tempNowValue');
  const humNowEl = document.getElementById('humNowValue');
  const rawInd = document.getElementById('rawIndicator');
  const tempInd = document.getElementById('tempIndicator');
  const humInd = document.getElementById('humIndicator');

  // RAW value & SMOKE
  if (rawNum === null) {
    rawNowEl.innerText = 'RAW: —';
    rawNowEl.style.color = '#333';
    rawInd.innerText = 'SMOKE: NO';
    rawInd.className = 'indicator no';
  } else {
    rawNowEl.innerText = 'RAW: ' + rawNum;
    if (threshold !== null && !isNaN(threshold) && rawNum > threshold) {
      rawNowEl.style.color = '#c62828'; // rojo
      rawInd.innerText = 'SMOKE: YES';
      rawInd.className = 'indicator yes';
    } else {
      rawNowEl.style.color = '#333';
      rawInd.innerText = 'SMOKE: NO';
      rawInd.className = 'indicator no';
    }
  }

  // Temp value & FIRE (uses 'fire' flag from device)
  if (tNum === null) {
    tempNowEl.innerText = '— °C';
    tempNowEl.style.color = '#333';
    tempInd.innerText = 'FIRE: NO';
    tempInd.className = 'indicator no';
  } else {
    tempNowEl.innerText = tNum.toFixed(2) + ' °C';
    if (fire) {
      tempNowEl.style.color = '#c62828';
      tempInd.innerText = 'FIRE: YES';
      tempInd.className = 'indicator yes';
    } else {
      tempNowEl.style.color = '#333';
      tempInd.innerText = 'FIRE: NO';
      tempInd.className = 'indicator no';
    }
  }

  // Hum value & FIRE indicator (same flag)
  if (hNum === null) {
    humNowEl.innerText = '— %';
    humNowEl.style.color = '#333';
    humInd.innerText = 'FIRE: NO';
    humInd.className = 'indicator no';
  } else {
    humNowEl.innerText = hNum.toFixed(2) + ' %';
    if (fire) {
      humNowEl.style.color = '#c62828';
      humInd.innerText = 'FIRE: YES';
      humInd.className = 'indicator yes';
    } else {
      humNowEl.style.color = '#333';
      humInd.innerText = 'FIRE: NO';
      humInd.className = 'indicator no';
    }
  }

  mqChart.update('none');
  tChart.update('none');
  hChart.update('none');
}

/* UI helpers */
function setButtonsConnected(connected){
  document.getElementById('btnSnap').disabled = !connected;
  document.getElementById('btnCalibMQ').disabled = !connected;
  document.getElementById('btnCalibEnv').disabled = !connected;
  document.getElementById('btnCalibAll').disabled = !connected;
  document.getElementById('btnConnect').innerText = connected ? 'Desconectar' : 'Conectar BLE';
  document.getElementById('status').innerText = connected ? 'Conectado' : 'Desconectado';
}

function onDisconnected(){
  appendDebug('GATT disconnected');
  setButtonsConnected(false);
  device = server = service = dataChar = cmdChar = null;
}

/* Conectar BLE */
async function connectBLE(){
  try{
    document.getElementById('status').innerText = 'Buscando PyroPrev (BLE)...';
    try {
      device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'PyroPrev' }], optionalServices: [SERVICE_UUID] });
    } catch(e) {
      appendDebug('Filtro no encontró dispositivo, reintentando acceptAllDevices');
      device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [SERVICE_UUID] });
    }
    if (!device) { document.getElementById('status').innerText = 'No se seleccionó dispositivo'; return; }
    device.addEventListener('gattserverdisconnected', onDisconnected);
    document.getElementById('status').innerText = 'Conectando...';
    server = await device.gatt.connect();
    appendDebug('GATT connected: ' + (device.name||device.id));
    service = await server.getPrimaryService(SERVICE_UUID);
    dataChar = await service.getCharacteristic(DATA_UUID);
    cmdChar  = await service.getCharacteristic(CMD_UUID);
    await dataChar.startNotifications();
    dataChar.addEventListener('characteristicvaluechanged', handleDataNotification);
    setButtonsConnected(true);
    document.getElementById('status').innerText = 'Conectado: ' + (device.name || '(sin nombre)');
  } catch (err) {
    appendDebug('connectBLE error: ' + (err && err.message ? err.message : err));
    setButtonsConnected(false);
    document.getElementById('status').innerText = 'Error conexión';
  }
}

/* Reensamblado + parse robusto (separador '\n') */
function handleDataNotification(event){
  try {
    const value = event.target.value;
    if (!value) return;
    const arr = new Uint8Array(value.buffer, value.byteOffset, value.byteLength);
    const fragment = new TextDecoder().decode(arr);
    if (document.getElementById('chkShowRaw').checked) appendDebug('Fragment (len=' + arr.length + '): ' + JSON.stringify(fragment));
    pendingNotif += fragment;
    const parts = pendingNotif.split('\n');
    for (let i = 0; i < parts.length - 1; i++){
      let jsonStr = parts[i].trim();
      if (!jsonStr) continue;
      jsonStr = jsonStr.replace(/\bNaN\b/gi,'null').replace(/\bInfinity\b/gi,'null').replace(/\b-Infinity\b/gi,'null');
      if (document.getElementById('chkShowRaw').checked) appendDebug('Sanitized: ' + jsonStr);
      try {
        const data = JSON.parse(jsonStr);
        if (typeof data.baseline === 'number') baseline = data.baseline;
        if (typeof data.threshold === 'number') threshold = data.threshold;

        const ts = (typeof data.ts === 'number') ? data.ts : Math.floor(Date.now()/1000);
        const raw = (typeof data.mqRaw === 'number') ? data.mqRaw : null;
        const avg = (typeof data.mqAvg === 'number') ? data.mqAvg : null;
        const temp = (typeof data.temp === 'number') ? data.temp : null;
        const hum  = (typeof data.hum === 'number') ? data.hum : null;
        const smoke = (typeof data.smoke === 'boolean') ? data.smoke : ( (raw !== null && typeof threshold === 'number') ? (raw > threshold) : false );
        const fire  = (typeof data.fire === 'boolean') ? data.fire : false;

        pushPoint(ts, raw, avg, temp, hum, smoke, fire);
        document.getElementById('status').innerText = 'Última lectura: ' + new Date(ts*1000).toLocaleTimeString();
      } catch (e) {
        appendDebug('JSON parse failed: ' + jsonStr + ' -> ' + (e && e.message ? e.message : e));
      }
    }
    pendingNotif = parts[parts.length - 1];
  } catch (err) {
    appendDebug('notification parse error: ' + (err && err.message ? err.message : err));
  }
}

/* Enviar comando (write) */
async function sendCmd(cmd){
  if (!cmdChar) { appendDebug('No cmd characteristic'); document.getElementById('status').innerText='Sin CMD'; return; }
  try {
    const enc = new TextEncoder();
    await cmdChar.writeValue(enc.encode(cmd));
    appendDebug('CMD sent: ' + cmd);
    document.getElementById('status').innerText = 'Comando enviado: ' + cmd;
  } catch (err) {
    appendDebug('sendCmd error: ' + (err && err.message ? err.message : err));
    document.getElementById('status').innerText = 'Error enviando cmd';
  }
}

/* Wiring UI */
document.getElementById('btnConnect').addEventListener('click', async ()=> {
  try {
    if (device && device.gatt && device.gatt.connected) { device.gatt.disconnect(); document.getElementById('status').innerText='Desconectando...'; return; }
    if (!navigator.bluetooth) { alert('Web Bluetooth no soportado. Usa Chrome Android.'); return; }
    await connectBLE();
  } catch (e) { appendDebug('btnConnect error: ' + e); }
});
document.getElementById('btnSnap').addEventListener('click', ()=> sendCmd('SNAP'));
document.getElementById('btnCalibMQ').addEventListener('click', ()=> { if (confirm('Calibrar MQ en AIRE LIMPIO?')) sendCmd('MQ'); });
document.getElementById('btnCalibEnv').addEventListener('click', ()=> { if (confirm('Calibrar Temp/Hum?')) sendCmd('ENV'); });
document.getElementById('btnCalibAll').addEventListener('click', ()=> { if (confirm('Calibrar TODO (MQ + Temp/Hum)?')) sendCmd('ALL'); });
document.getElementById('btnTestData').addEventListener('click', ()=> {
  const ts = Math.floor(Date.now()/1000);
  const r = Math.floor(Math.random()*1000);
  const a = Math.floor(Math.random()*1000);
  const t = (20 + Math.random()*10).toFixed(2);
  const h = (30 + Math.random()*40).toFixed(2);
  // heurística simple para test: smoke si r>threshold, fire false
  const smoke = (r > threshold);
  const fire = false;
  pushPoint(ts, r, a, Number(t), Number(h), smoke, fire);
  appendDebug('Test point added: ' + ts + ' r=' + r + ' a=' + a + ' t=' + t + ' h=' + h);
  document.getElementById('status').innerText = 'Test point added';
});

/* init */
makeCharts();
setButtonsConnected(false);
window.addEventListener('beforeunload', ()=> { try { if (device && device.gatt && device.gatt.connected) device.gatt.disconnect(); } catch(e){} });
</script>
</body>
</html>
